# Traefik-Deployment â€” The Traefik Toolset

A reusable, hardened, Dockerâ€‘first reverse proxy setup with **Traefik**, **Cloudflare DNSâ€‘01 (Letâ€™s Encrypt)**, systemâ€‘level management scripts, and optional deployment automation.

This repository provides a complete toolset for operating Traefik on a Linux host with minimal privileges, clean separation between concerns, and optional automation tools for managing multiple containerized sites.

---

## ğŸš€ What the Traefik Toolset Does

The toolset installs and manages:

### **1. A productionâ€‘ready Traefik reverse proxy**

- Automatic HTTPS via DNSâ€‘01 (Cloudflare)
- Certificate autoâ€‘renewal
- Isolation in a dedicated Docker network
- Support for multiple sites/containers behind the same proxy

### **2. Systemâ€‘level scripts for Traefik lifecycle**

Located in `scripts/`, these include:

- `create_network.sh` â€” ensures the shared `traefik_proxy` Docker network exists  
- `traefik_up.sh` â€” starts Traefik using environment variables + static docker-compose  
- `deploy_site.sh` â€” deploys a site to Traefik  
- `update_site.sh` â€” refreshes a site with the latest image  
- `remove_site.sh` â€” undeploys a site cleanly  

These scripts run with the minimal required host privileges and never store secrets on disk.

### **3. Optional Webhook Automation (systemd)**

For users who want *automatic redeployments* after GitHub Actions builds:

- A minimal webhook listener (`webhook.service`)
- Validates GitHub signatures  
- Runs the restricted systemâ€‘level update command  
- Fully isolated from Traefik  
- Does **not** run inside a container  
- Requires no shell inside a container  
- Avoids the complexity of bindâ€‘mounting docker.sock into automation containers  

This systemdâ€‘based approach is the most secure and the least errorâ€‘prone way to automate deployments.

---

## ğŸ“¦ Environment Variables (.env)

To keep scripts static and clean, the toolset supports a `.env` file next to the Traefik installation.

Create `/opt/traefik/.env` with:

```plaintext
CF_API_TOKEN=your_cloudflare_token
EMAIL=you@example.com
USE_STAGING=false
```

Traefik resolves all environment variables automatically through:

- the dockerâ€‘compose file
- script references
- systemd units (optional)

This keeps secrets **out of your repository** and out of the command history.

---

## ğŸ§° Installing the Traefik Toolset (on the host)

SSH into your server and run:

```bash
sudo git clone https://github.com/joshphillipssr/Traefik-Deployment.git /opt/traefik
```

### Step 1 â€” Create the shared Docker network

```bash
cd /opt/traefik
sudo ./traefik/scripts/create_network.sh
```

### Step 2 â€” Create your `.env` file

```bash
sudo nano /opt/traefik/traefik/.env
```

Fill in:

```plaintext
CF_API_TOKEN=...
EMAIL=...
USE_STAGING=false
```

### Step 3 â€” Start Traefik

```bash
cd /opt/traefik
sudo ./traefik/scripts/traefik_up.sh
```

Traefik will come up with automatic HTTPS, and anytime your `.env` changes, rerunning this script updates the configuration without wiping your certificates.

---

## ğŸŒ Deploying a Site

Each site lives inside `/opt/sites/<site-name>` with its own docker-compose file dynamically generated by the toolset.

Example:

```bash
sudo ./traefik/scripts/deploy_site.sh \
  SITE_NAME="jpsr" \
  SITE_HOSTS="joshphillipssr.com www.joshphillipssr.com" \
  SITE_IMAGE="ghcr.io/joshphillipssr/jpsr-site:latest"
```

This:

âœ” Creates `/opt/sites/jpsr/`  
âœ” Generates a correct Traefikâ€‘aware docker-compose  
âœ” Attaches the container to `traefik_proxy`  
âœ” Starts the site with automatic HTTPS  

---

## ğŸ”„ Updating a Site Manually

```bash
sudo ./traefik/scripts/update_site.sh SITE_NAME="jpsr"
```

This pulls latest images and restarts the container cleanly.

---

## ğŸ§¨ Removing a Site

```bash
sudo ./traefik/scripts/remove_site.sh SITE_NAME="jpsr"
```

This tears the container down and deletes its directory.

---

## ğŸ”” Optional: Automatic Deployment via Webhooks (systemd)

This is the *secure*, *reliable*, and *recommended* automation workflow.

### What It Does

- Listens for GitHub â€œworkflow_runâ€ completion events  
- Verifies the signature  
- Calls `update_site.sh` for the correct site  
- Runs under a lockedâ€‘down system user  
- Does **not** need docker.sock inside a container  
- Does **not** require sudo password  
- Reloads config automatically  

### Install the Webhook Toolset

```bash
sudo /opt/traefik/traefik/scripts/hooks_up.sh
```

This will:

âœ” Create `/opt/traefik/hooks/`  
âœ” Write `hooks.json`  
âœ” Install `webhook.service` under systemd  
âœ” Install `/etc/sudoers.d/webhook-deploy`  
âœ” Start & enable the service  

### Configure GitHub

Webhook URL format:

```plaintext
https://hooks.<your-domain>/hooks/deploy-<site>
```

Example:

```plaintext
https://hooks.joshphillipssr.com/hooks/deploy-jpsr
```

Event type: **Workflow runs**  
Content-Type: **application/json**  
Secret: matching the one in `hooks.json`  

### Test Your Pipeline

Push to `main`, let GitHub Actions finish, and watch:

```bash
sudo journalctl -u webhook -f
```

Youâ€™ll see the deploy fire automatically.

---

## ğŸ§± Architecture Overview

Traefik serves as the front door:

```plaintext
 Client â†’ Cloudflare â†’ Traefik â†’ Site Containers
```

All site containers run behind the same shared docker network:

```plaintext
docker network: traefik_proxy
```

Traefik issues certificates *automatically* for any hostname referenced in container labels â€” no further config required.

---

## ğŸ“ Notes & Best Practices

- Never commit `.env` filesâ€”keep secrets out of git
- Cloudflare SSL/TLS mode: **Full (strict)**
- Use `USE_STAGING=true` when testing new hosts
- The webhook service reloads `hooks.json` dynamically
- All tools are stateless and safe to rerun anytime

---

## ğŸ“œ License

MIT License.
